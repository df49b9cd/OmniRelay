// <auto-generated>
// Generated by protoc-gen-omnirelay-csharp. Do not edit.
// </auto-generated>
#nullable enable

using System;
using System.Collections.Generic;
using System.Threading;
using System.Threading.Tasks;
using OmniRelay.Core;
using OmniRelay.Core.Clients;
using OmniRelay.Core.Transport;
using Hugo;
using OmniRelay.Dispatcher;
using static Hugo.Go;

namespace OmniRelay.Tests.Protos;

public static class TestServiceOmniRelay
{
    private static readonly ProtobufCodec<global::OmniRelay.Tests.Protos.UnaryRequest, global::OmniRelay.Tests.Protos.UnaryResponse> __UnaryCallCodec = new(defaultEncoding: "protobuf");
    private static readonly ProtobufCodec<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.StreamResponse> __ServerStreamCodec = new(defaultEncoding: "protobuf");
    private static readonly ProtobufCodec<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.UnaryResponse> __ClientStreamCodec = new(defaultEncoding: "protobuf");
    private static readonly ProtobufCodec<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.StreamResponse> __DuplexStreamCodec = new(defaultEncoding: "protobuf");

    public static void RegisterTestService(this global::OmniRelay.Dispatcher.Dispatcher dispatcher, ITestService implementation)
    {
        ArgumentNullException.ThrowIfNull(dispatcher);
        ArgumentNullException.ThrowIfNull(implementation);

        dispatcher.RegisterUnary("UnaryCall", builder =>
        {
            builder.WithEncoding(__UnaryCallCodec.Encoding);
            builder.Handle(ProtobufCallAdapters.CreateUnaryHandler(__UnaryCallCodec, implementation.UnaryCallAsync));
        }).ValueOrChecked();

        dispatcher.RegisterStream("ServerStream", builder =>
        {
            builder.WithEncoding(__ServerStreamCodec.Encoding);
            builder.Handle(ProtobufCallAdapters.CreateServerStreamHandler(__ServerStreamCodec, implementation.ServerStreamAsync));
        }).ValueOrChecked();

        dispatcher.RegisterClientStream("ClientStream", builder =>
        {
            builder.WithEncoding(__ClientStreamCodec.Encoding);
            builder.Handle(ProtobufCallAdapters.CreateClientStreamHandler(__ClientStreamCodec, implementation.ClientStreamAsync));
        }).ValueOrChecked();

        dispatcher.RegisterDuplex("DuplexStream", builder =>
        {
            builder.WithEncoding(__DuplexStreamCodec.Encoding);
            builder.Handle(ProtobufCallAdapters.CreateDuplexHandler(__DuplexStreamCodec, implementation.DuplexStreamAsync));
        }).ValueOrChecked();

    }

    public interface ITestService
    {
        ValueTask<Response<global::OmniRelay.Tests.Protos.UnaryResponse>> UnaryCallAsync(Request<global::OmniRelay.Tests.Protos.UnaryRequest> request, CancellationToken cancellationToken);
        ValueTask ServerStreamAsync(Request<global::OmniRelay.Tests.Protos.StreamRequest> request, ProtobufCallAdapters.ProtobufServerStreamWriter<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.StreamResponse> stream, CancellationToken cancellationToken);
        ValueTask<Response<global::OmniRelay.Tests.Protos.UnaryResponse>> ClientStreamAsync(ProtobufCallAdapters.ProtobufClientStreamContext<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.UnaryResponse> context, CancellationToken cancellationToken);
        ValueTask DuplexStreamAsync(ProtobufCallAdapters.ProtobufDuplexStreamContext<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.StreamResponse> context, CancellationToken cancellationToken);
    }

    public sealed class TestServiceClient
    {
        private readonly global::OmniRelay.Dispatcher.Dispatcher _dispatcher;
        private readonly string _service;
        private readonly string? _outboundKey;
        private UnaryClient<global::OmniRelay.Tests.Protos.UnaryRequest, global::OmniRelay.Tests.Protos.UnaryResponse>? _unaryCallUnaryClient;
        private StreamClient<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.StreamResponse>? _serverStreamStreamClient;
        private ClientStreamClient<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.UnaryResponse>? _clientStreamClientStream;
        private DuplexStreamClient<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.StreamResponse>? _duplexStreamDuplexClient;

        internal TestServiceClient(global::OmniRelay.Dispatcher.Dispatcher dispatcher, string service, string? outboundKey)
        {
            ArgumentNullException.ThrowIfNull(dispatcher);
            ArgumentException.ThrowIfNullOrWhiteSpace(service);
            _dispatcher = dispatcher;
            _service = service;
            _outboundKey = outboundKey;
        }

        public ValueTask<Result<Response<global::OmniRelay.Tests.Protos.UnaryResponse>>> UnaryCallAsync(global::OmniRelay.Tests.Protos.UnaryRequest request, RequestMeta? meta = null, CancellationToken cancellationToken = default)
        {
            var requestMeta = PrepareRequestMeta(meta, _service, "UnaryCall", __UnaryCallCodec.Encoding);
            var client = _unaryCallUnaryClient;
            if (client is null)
            {
                var createResult = _dispatcher.CreateUnaryClient<global::OmniRelay.Tests.Protos.UnaryRequest, global::OmniRelay.Tests.Protos.UnaryResponse>(_service, __UnaryCallCodec, _outboundKey);
                if (createResult.IsFailure)
                {
                    return ValueTask.FromResult(Result.Fail<Response<global::OmniRelay.Tests.Protos.UnaryResponse>>(createResult.Error!));
                }

                client = _unaryCallUnaryClient = createResult.Value;
            }

            return client.CallAsync(new Request<global::OmniRelay.Tests.Protos.UnaryRequest>(requestMeta, request), cancellationToken);
        }

        public IAsyncEnumerable<Result<Response<global::OmniRelay.Tests.Protos.StreamResponse>>> ServerStreamAsync(global::OmniRelay.Tests.Protos.StreamRequest request, RequestMeta? meta = null, CancellationToken cancellationToken = default)
        {
            var requestMeta = PrepareRequestMeta(meta, _service, "ServerStream", __ServerStreamCodec.Encoding);
            var client = _serverStreamStreamClient;
            if (client is null)
            {
                var createResult = _dispatcher.CreateStreamClient<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.StreamResponse>(_service, __ServerStreamCodec, _outboundKey);
                if (createResult.IsFailure)
                {
                    return StreamFailure<global::OmniRelay.Tests.Protos.StreamResponse>(createResult.Error!);
                }

                client = _serverStreamStreamClient = createResult.Value;
            }

            return client.CallAsync(new Request<global::OmniRelay.Tests.Protos.StreamRequest>(requestMeta, request), new StreamCallOptions(StreamDirection.Server), cancellationToken);
        }

        public ValueTask<Result<ClientStreamClient<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.UnaryResponse>.ClientStreamSession>> ClientStreamAsync(RequestMeta? meta = null, CancellationToken cancellationToken = default)
        {
            var requestMeta = PrepareRequestMeta(meta, _service, "ClientStream", __ClientStreamCodec.Encoding);
            var client = _clientStreamClientStream;
            if (client is null)
            {
                var createResult = _dispatcher.CreateClientStreamClient<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.UnaryResponse>(_service, __ClientStreamCodec, _outboundKey);
                if (createResult.IsFailure)
                {
                    return ValueTask.FromResult(Result.Fail<ClientStreamClient<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.UnaryResponse>.ClientStreamSession>(createResult.Error!));
                }

                client = _clientStreamClientStream = createResult.Value;
            }

            return client.StartAsync(requestMeta, cancellationToken);
        }

        public ValueTask<Result<DuplexStreamClient<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.StreamResponse>.DuplexStreamSession>> DuplexStreamAsync(RequestMeta? meta = null, CancellationToken cancellationToken = default)
        {
            var requestMeta = PrepareRequestMeta(meta, _service, "DuplexStream", __DuplexStreamCodec.Encoding);
            var client = _duplexStreamDuplexClient;
            if (client is null)
            {
                var createResult = _dispatcher.CreateDuplexStreamClient<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.StreamResponse>(_service, __DuplexStreamCodec, _outboundKey);
                if (createResult.IsFailure)
                {
                    return ValueTask.FromResult(Result.Fail<DuplexStreamClient<global::OmniRelay.Tests.Protos.StreamRequest, global::OmniRelay.Tests.Protos.StreamResponse>.DuplexStreamSession>(createResult.Error!));
                }

                client = _duplexStreamDuplexClient = createResult.Value;
            }

            return client.StartAsync(requestMeta, cancellationToken);
        }

        private static RequestMeta PrepareRequestMeta(RequestMeta? meta, string service, string procedure, string encoding)
        {
            if (meta is null)
            {
                return new RequestMeta(service: service, procedure: procedure, encoding: encoding);
            }

            var value = meta;
            if (string.IsNullOrWhiteSpace(value.Service))
            {
                value = value with { Service = service };
            }
            if (string.IsNullOrWhiteSpace(value.Procedure))
            {
                value = value with { Procedure = procedure };
            }
            if (string.IsNullOrWhiteSpace(value.Encoding))
            {
                value = value with { Encoding = encoding };
            }
            return value;
        }
        private static async IAsyncEnumerable<Result<Response<TResponse>>> StreamFailure<TResponse>(Error error)
        {
            yield return Result.Fail<Response<TResponse>>(error);
        }
    }

    public static TestServiceClient CreateTestServiceClient(global::OmniRelay.Dispatcher.Dispatcher dispatcher, string service, string? outboundKey = null)
    {
        ArgumentNullException.ThrowIfNull(dispatcher);
        ArgumentException.ThrowIfNullOrWhiteSpace(service);
        return new TestServiceClient(dispatcher, service, outboundKey);
    }
}
