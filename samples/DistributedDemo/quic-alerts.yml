groups:
  - name: quic-http3-alerts
    interval: 30s
    rules:
      - alert: HighHTTP3FallbackRate
        expr: |
          (sum(rate(omnirelay_http_requests_completed_total{network_protocol_version!="3"}[5m])) > 0)
          and
          (sum(rate(omnirelay_http_requests_completed_total{network_protocol_version="3"}[5m])) > 0)
          and
          (sum(rate(omnirelay_http_requests_completed_total{network_protocol_version!="3"}[5m]))
            /
           sum(rate(omnirelay_http_requests_completed_total[5m])) > 0.2)
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "HTTP/3 fallback rate above 20%"
          description: "More than 20% of requests are served over HTTP/2/1.1 instead of HTTP/3. Investigate QUIC availability."

      - alert: HTTP3LatencyRegressionP95
        expr: |
          histogram_quantile(0.95, sum by (le) (rate(omnirelay_http_request_duration_bucket{network_protocol_version="3"}[5m]))) > 0.250
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "HTTP/3 p95 latency regression"
          description: "p95 latency for HTTP/3 exceeds 250ms. Compare to HTTP/2 and check QUIC congestion or packet loss."
